# Проект автоматического регулярного переобучения модели обнаружения мошенничества

Данный проект представляет собой MLOps-инфраструктуру для автоматического регулярного переобучения модели обнаружения мошенничества в финансовых транзакциях. Инфраструктура создается и управляется с помощью Terraform в облаке Yandex Cloud.

## Компоненты проекта

Проект состоит из следующих компонентов:

1. **Инфраструктура** (директория `/infra`):
   - Кластер PostgreSQL - хранение метаданных экспериментов MLflow
   - Сервер MLflow - отслеживание экспериментов и хранение моделей
   - S3-хранилище - хранение артефактов экспериментов

2. **Модель** (директория `/src`):
   - PySpark-скрипт для обучения модели обнаружения мошенничества
   - Логика сравнения и регистрации моделей

3. **Оркестрация** (директория `/dags`):
   - Airflow DAG для регулярного запуска процесса обучения
   - Создание кластера Dataproc для обучения модели

4. **Вспомогательные скрипты** (директория `/scripts`):
   - Генерация демонстрационных данных для обучения
   - Загрузка скриптов в S3-хранилище
   - Настройка переменных окружения

## Архитектура решения

1. **Исходные данные** хранятся в S3-хранилище
2. **Airflow DAG** запускается по расписанию и создает кластер Dataproc
3. **PySpark скрипт** запускается на кластере Dataproc, обучает модель и логирует ее в MLflow
4. **MLflow** отслеживает эксперименты, хранит модели и метрики
5. **PostgreSQL** хранит метаданные экспериментов MLflow

## Начало работы

### Предварительные требования

- [Terraform](https://www.terraform.io/downloads.html) >= 1.0.0
- [Yandex Cloud CLI](https://cloud.yandex.ru/docs/cli/quickstart)
- [Python](https://www.python.org/downloads/) == 3.11
- [s3cmd](https://s3tools.org/download)

### Шаг 1: Настройка переменных окружения

```bash
cd scripts
./make_env.sh
```

Скрипт создаст файл `.env` с необходимыми переменными окружения. Заполните их согласно вашим данным аккаунта Yandex Cloud.

### Шаг 2: Создание инфраструктуры с помощью Terraform

```bash
cd infra
terraform init
terraform apply
```

После создания инфраструктуры, Terraform выведет значения выходных переменных, включая URL сервера MLflow и другие необходимые параметры.

### Шаг 3: Генерация демонстрационных данных

```bash
cd scripts
./create_demo_data.py
```

Скрипт создаст синтетические данные о транзакциях и загрузит их в S3-хранилище.

### Шаг 4: Загрузка PySpark-скрипта в S3-хранилище

```bash
cd scripts
./upload_to_s3.sh
```

Скрипт загрузит файл `src/fraud_detection_model.py` в S3-хранилище.

### Шаг 5: Настройка Airflow и запуск DAG

1. Добавьте файл DAG `dags/fraud_detection_training.py` в вашу директорию DAG Airflow.
2. Создайте необходимые соединения в Airflow:
   - Yandex Cloud Connection
   - S3 Connection
3. Включите DAG в веб-интерфейсе Airflow.

## Работа с MLflow

После запуска MLflow-сервера вы можете открыть его веб-интерфейс по адресу, который был выведен после выполнения `terraform apply`.

В интерфейсе MLflow вы сможете:
- Просматривать эксперименты и их метрики
- Сравнивать модели между собой
- Загружать зарегистрированные модели

## Структура проекта

```
/
├── dags/                  # Airflow DAGs
│   └── fraud_detection_training.py
├── infra/                 # Terraform конфигурация
│   ├── main.tf
│   ├── variables.tf 
│   ├── outputs.tf
│   └── terraform.tfvars.example
├── scripts/               # Вспомогательные скрипты
│   ├── create_demo_data.py
│   ├── make_env.sh
│   └── upload_to_s3.sh
├── src/                   # Исходный код модели
│   └── fraud_detection_model.py
└── README.md              # Это файл
```

## Автоматическое переобучение модели

После настройки всех компонентов система будет автоматически:

1. Запускать процесс обучения по расписанию (по умолчанию каждые 30 минут)
2. Сравнивать метрики новой модели с текущей зарегистрированной моделью
3. Регистрировать новую модель в MLflow, если она показывает лучшие результаты

## Разработка и вклад в проект

Если вы хотите внести свой вклад в проект:

1. Форкните репозиторий
2. Создайте ветку для вашей функциональности
3. Сделайте коммиты ваших изменений
4. Отправьте пулл-реквест в основной репозиторий

## Лицензия

Этот проект распространяется под лицензией MIT.

## Автор

[NickOsipov](https://t.me.com/NickOsipov)
